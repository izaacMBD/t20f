<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tormenta20 — Ficha (com Defesa, PV/PM, Ataques, Equipamentos)</title>
  <style>
    :root{ --bg:#06060a; --fg:#eef0f2; --muted:#98a0a6; --card:#0f1114; --accent:#1f8feb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:var(--fg);padding:12px}
    .app{max-width:980px;margin:0 auto}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button,.btn{background:transparent;border:1px solid var(--muted);padding:8px 10px;border-radius:8px;font-size:13px;color:var(--fg);cursor:pointer}
    .btn.sm{padding:6px 8px;font-size:12px;border-radius:6px}
    .sheet{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .card{background:var(--card);border-radius:10px;padding:12px;border:1px solid #131416}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #222;background:#05060a;color:#fff;font-size:14px}
    input[type="checkbox"]{transform:scale(1.1);margin-right:6px}
    textarea{min-height:64px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1;min-width:120px}
    .small{flex:0 0 86px}
    .section-title{font-weight:700;margin-bottom:6px}
    footer{margin:12px 0 40px;font-size:12px;color:var(--muted)}
    .skills-container{max-height:340px;overflow-y:auto;padding:6px;border:1px solid #131416;border-radius:8px;display:flex;flex-direction:column;gap:6px}
    .skill-row{background:#0b0c0f;border:1px solid #181a1d;border-radius:8px;padding:8px;display:grid;grid-template-columns:1fr 72px 72px 80px 84px;gap:8px;align-items:center}
    .skill-row .name{font-weight:600}
    .skill-row input[type="number"]{padding:6px;height:36px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .tiny{font-size:12px;color:var(--muted)}
    .top-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:8px}
    .card.small{padding:8px}
    .card .card-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px}
    .card .display-row{display:flex;gap:6px;align-items:flex-start;flex-wrap:wrap}
    input[readonly]{opacity:0.85;background:#0a0a0c}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px dashed #151617;text-align:left}
    .muted-note{font-size:12px;color:#9aa3a9}
    @media (max-width:720px){
      .skill-row{grid-template-columns:1fr 60px 60px 72px 72px}
      .small{flex:0 0 72px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Tormenta20 — Ficha (perícias + defesa, PV/PM, ataques e equipamentos)</h1>
      <div class="controls">
        <button id="btnSave" class="btn">Salvar JSON</button>
        <button id="btnLoad" class="btn">Carregar JSON</button>
        <button id="btnPrint" class="btn">Imprimir / PDF</button>
        <input id="fileLoader" type="file" accept="application/json" style="display:none">
      </div>
    </header>

    <form id="sheet" class="sheet" autocomplete="off" onsubmit="return false;">
      <!-- IDENTIFICAÇÃO -->
      <section class="card">
        <div class="row">
          <div class="col">
            <label class="section-title">Nome do Personagem</label>
            <input type="text" id="nome" name="nome" placeholder="Nome do personagem">
          </div>
          <div class="small">
            <label class="section-title">Lv</label>
            <input type="number" id="nivel" name="nivel" min="1" value="1">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Jogador</label><input type="text" id="jogador" name="jogador"></div>
          <div class="col"><label>Raça</label><input type="text" id="raca" name="raca"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Origem</label><input type="text" id="origem" name="origem"></div>
          <div class="col"><label>Classe</label><input type="text" id="classe" name="classe"></div>
          <div class="col"><label>Divindade</label><input type="text" id="divindade" name="divindade"></div>
        </div>
      </section>

      <!-- ATRIBUTOS -->
      <section class="card">
        <div class="section-title">Atributos</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px">
            <label>Força</label>
            <input type="number" id="forca" name="forca" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modFor" name="modFor" value="0">
          </div>
          <div style="flex:1;min-width:120px">
            <label>Destreza</label>
            <input type="number" id="destreza" name="destreza" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modDes" name="modDes" value="0">
          </div>
          <div style="flex:1;min-width:120px">
            <label>Constituição</label>
            <input type="number" id="const" name="const" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modCon" name="modCon" value="0">
          </div>
          <div style="flex:1;min-width:120px">
            <label>Inteligência</label>
            <input type="number" id="int" name="int" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modInt" name="modInt" value="0">
          </div>
          <div style="flex:1;min-width:120px">
            <label>Sabedoria</label>
            <input type="number" id="sab" name="sab" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modSab" name="modSab" value="0">
          </div>
          <div style="flex:1;min-width:120px">
            <label>Carisma</label>
            <input type="number" id="car" name="car" value="10" step="1" min="1">
            <label class="tiny" style="margin-top:6px">Mod</label>
            <input type="number" id="modCar" name="modCar" value="0">
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <label class="muted">
            <input type="checkbox" id="autoMods"> Calcular mods automaticamente a partir do valor do atributo
          </label>
          <div class="tiny muted">(tabela padrão — 1:-5, 2-3:-4, 4-5:-3, 6-7:-2, 8-9:-1, 10-11:0, 12-13:+1, ...)</div>
        </div>
      </section>

      <!-- PV / PM -->
      <section class="card">
        <div class="section-title">Pontos de Vida & Mana</div>
        <div class="row">
          <div class="col"><label>PVs Máximos</label><input type="number" id="pvsMax" value="" min="0"></div>
          <div class="col"><label>PVs Atuais</label><input type="number" id="pvsAtual" value="" min="0"></div>
          <div class="col"><label>PMs Máximos</label><input type="number" id="pmsMax" value="" min="0"></div>
          <div class="col"><label>PMs Atuais</label><input type="number" id="pmsAtual" value="" min="0"></div>
        </div>
      </section>

      <!-- ATAQUES (até 5) -->
      <section class="card">
        <div class="section-title">Ataques (até 5)</div>
        <table>
          <thead><tr><th>Nome</th><th>Bônus</th><th>Dano</th><th>Crítico</th><th>Tipo</th><th>Alcance</th></tr></thead>
          <tbody id="attacksTbody">
            <!-- será populado via JS (5 linhas) -->
          </tbody>
        </table>
      </section>

      <!-- PERÍCIAS -->
      <section class="card">
        <div class="section-title">Perícias</div>
        <div class="tiny muted" style="margin-bottom:8px">
          1/2 do nível + mod. de atributo (padrão ou alternado) + treino (+2) + outros
        </div>
      
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
          <label class="muted"><input type="checkbox" id="useGlobalAttrForSkills" checked> Usar modificadores de atributo padrão (campo "modX" acima). Se desmarcar, escolha atributo por perícia.</label>
        </div>
      
        <div id="skillsContainer" class="skills-container" aria-label="Lista de perícias">
          <!-- será populado por JavaScript -->
        </div>
      </section>

      <!-- DEFESA / ARMADURA & ESCUDO -->
      <section class="card">
        <div class="section-title">Defesa / Armadura & Escudo</div>
        <div class="row">
          <div class="col"><label>CA (Total)</label><input type="number" id="caTotal" value="10"></div>
          <div class="col"><label>Base CA</label><input type="number" id="caBase" value="10"></div>
          <div class="col"><label>Bônus Armadura</label><input type="number" id="bonusArm" value="0"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Bônus Escudo</label><input type="number" id="bonusEsc" value="0"></div>
          <div class="col"><label>Penalidade de Armadura</label><input type="number" id="penalidadeArm" value="0"></div>
          <div class="col"><label>Outros Bônus</label><input type="number" id="outrosDef" value="0"></div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <div style="flex:1;min-width:160px">
            <label>Armadura (nome)</label><input type="text" id="armaduraNome">
          </div>
          <div style="min-width:120px">
            <label>P. Armadura</label><input type="number" id="pArmadura" value="0">
          </div>
          <div style="flex:1;min-width:160px">
            <label>Escudo (nome)</label><input type="text" id="escudoNome">
          </div>
          <div style="min-width:120px">
            <label>P. Escudo</label><input type="number" id="pEscudo" value="0">
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Proficiências (texto)</label>
          <input type="text" id="proficiencias" placeholder="Ex: Armaduras leves, escudos, armas simples...">
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="min-width:200px">
            <label>Tamanho</label>
            <select id="tamanho">
              <option value="Minúsculo">Minúsculo</option>
              <option value="Pequeno">Pequeno</option>
              <option value="Médio" selected>Médio</option>
              <option value="Grande">Grande</option>
              <option value="Gigante">Gigante</option>
            </select>
          </div>
          <div style="min-width:160px">
            <label>Deslocamento (m)</label><input type="number" id="desloc" value="9" min="0">
          </div>
          <div style="flex:1">
            <div class="muted-note">Modificador de atributo usado para Defesa (selecione no PDF): mostrado como mod de Destreza por padrão.</div>
          </div>
        </div>
      </section>

      <!-- ITENS / EQUIPAMENTOS (com peso) -->
      <section class="card">
        <div class="section-title">Equipamentos (nome + peso)</div>
        <div id="equipList" class="list"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="button" id="addEquip" class="btn">+ Adicionar Equipamento</button>
          <button type="button" id="clearEquip" class="btn">Limpar</button>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center">
          <div style="min-width:160px">
            <label>Carga Máxima (3x Força)</label><input type="number" id="cargaMax" readonly>
          </div>
          <div style="min-width:160px">
            <label>Levantar (até 10x Força)</label><input type="number" id="levantar" readonly>
          </div>
          <div style="min-width:160px">
            <label>Carga Total</label><input type="number" id="cargaTotal" readonly>
          </div>
          <div style="min-width:220px">
            <label>Penalidade por Carga</label><input type="text" id="penalCarga" readonly>
          </div>
        </div>
      </section>

      <!-- ITENS/ARMAS/MAGIAS (mantidos) -->
      <section class="card">
        <div class="section-title">Itens livres</div>
        <div id="itens" class="list"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="button" id="addItem" class="btn">+ Adicionar Item</button>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Armas</div>
        <div id="armas" class="list"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="button" id="addArma" class="btn">+ Adicionar Arma</button>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Magias</div>
        <div id="magiasList" class="list"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="button" id="addMagia" class="btn">+ Adicionar Magia</button>
        </div>
      </section>
    </form>

    <footer class="tiny muted">Atualizado: adicionadas seções de Defesa, PV/PM, Ataques, Tamanho, Deslocamento e Carga. PDF mapping heurístico incluído. :contentReference[oaicite:1]{index=1}</footer>

    <!-- PDF controls -->
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <input id="fileLoaderPdf" type="file" accept="application/pdf" />
      <button id="btnExportPdf" class="btn">Exportar PDF preenchido</button>
      <div id="pdfStatus" class="muted tiny" style="margin-left:8px"></div>
    </div>
  </div>

  <!-- cards CRUD (igual adaptado) -->
  <script>
  (function(){
    let itemCount = 0, armaCount = 0, magiaCount = 0, equipCount = 0;

    function createCard(type, idx, data = {}) {
      const div = document.createElement('div');
      div.className = 'card small';
      div.dataset.type = type;
      div.dataset.idx = idx;
      const display = document.createElement('div'); const edit = document.createElement('div'); const actions = document.createElement('div');
      display.className='display'; edit.className='edit'; actions.className='card-actions';
      display.style.display = data.viewOnly ? 'flex' : 'none';
      edit.style.display = data.viewOnly ? 'none' : 'block';
      const btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.className='btn sm edit-btn'; btnEdit.textContent = data.viewOnly ? 'Editar' : 'Salvar';
      const btnRemove = document.createElement('button'); btnRemove.type='button'; btnRemove.className='btn sm remove-btn'; btnRemove.textContent='Remover';
      actions.appendChild(btnEdit); actions.appendChild(btnRemove);
      function escapeAttr(v){ if(v===undefined||v===null) return ''; return String(v).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function escapeHtml(v){ if(v===undefined||v===null) return ''; return String(v).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      if(type==='item'){ const nome=data.nome||''; const peso=data.peso||''; display.innerHTML = `<div class="display-row"><div class="label">Item</div><div><strong class="display-name">${escapeHtml(nome)}</strong></div><div class="label">Peso</div><div><span class="display-peso">${escapeHtml(String(peso))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Item" value="${escapeAttr(nome)}"><input type="number" class="field-peso" placeholder="Peso" value="${escapeAttr(peso)}"></div>`; }
      if(type==='arma'){ const nome=data.nome||''; const dano=data.dano||''; const bonus=data.bonus||''; display.innerHTML = `<div class="display-row"><div class="label">Nome</div><div><strong class="display-nome">${escapeHtml(nome)}</strong></div><div class="label">Dano</div><div><span class="display-dano">${escapeHtml(dano)}</span></div><div class="label">Bônus</div><div><span class="display-bonus">${escapeHtml(String(bonus))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Nome da Arma" value="${escapeAttr(nome)}"><input type="text" class="field-dano" placeholder="Dano" value="${escapeAttr(dano)}"><input type="number" class="field-bonus" placeholder="Bônus" value="${escapeAttr(bonus)}"></div>`; }
      if(type==='magia'){ const nome=data.nome||''; const desc=data.desc||''; display.innerHTML = `<div class="display-row"><div class="label">Magia</div><div><strong class="display-nome">${escapeHtml(nome)}</strong></div><div style="width:100%;margin-top:6px"><div class="label">Efeito</div><div class="display-desc">${escapeHtml(desc)}</div></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-direction:column"><input type="text" class="field-nome" placeholder="Nome da Magia" value="${escapeAttr(nome)}"><textarea class="field-desc" placeholder="Efeitos">${escapeAttr(desc)}</textarea></div>`; }
      if(type==='equip'){ const nome=data.nome||''; const peso=data.peso||''; display.innerHTML = `<div class="display-row"><div class="label">Equip</div><div><strong class="display-name">${escapeHtml(nome)}</strong></div><div class="label">Peso</div><div><span class="display-peso">${escapeHtml(String(peso))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Equipamento" value="${escapeAttr(nome)}"><input type="number" class="field-peso" placeholder="Peso" value="${escapeAttr(peso)}"></div>`; }

      div.appendChild(display); div.appendChild(edit); div.appendChild(actions);
      btnEdit.addEventListener('click', ()=>{ const isEditing = edit.style.display !== 'none'; if(isEditing){ if(type==='item' || type==='equip'){ const nomeVal = div.querySelector('.field-nome').value||''; const pesoVal = div.querySelector('.field-peso').value||''; div.querySelector('.display-name').textContent = nomeVal; div.querySelector('.display-peso').textContent = pesoVal; } if(type==='arma'){ const nomeVal = div.querySelector('.field-nome').value||''; const danoVal = div.querySelector('.field-dano').value||''; const bonusVal = div.querySelector('.field-bonus').value||''; div.querySelector('.display-nome').textContent = nomeVal; div.querySelector('.display-dano').textContent = danoVal; div.querySelector('.display-bonus').textContent = bonusVal; } if(type==='magia'){ const nomeVal = div.querySelector('.field-nome').value||''; const descVal = div.querySelector('.field-desc').value||''; div.querySelector('.display-nome').textContent = nomeVal; div.querySelector('.display-desc').textContent = descVal; } edit.style.display='none'; display.style.display='flex'; btnEdit.textContent='Editar'; updateCargaValues(); } else { edit.style.display='block'; display.style.display='none'; btnEdit.textContent='Salvar'; } });
      btnRemove.addEventListener('click', ()=>{ if(confirm('Remover este '+type+'?')) { div.remove(); updateCargaValues(); } });
      return div;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const itensEl=document.getElementById('itens'), armasEl=document.getElementById('armas'), magiasEl=document.getElementById('magiasList'), equipEl=document.getElementById('equipList');

      document.getElementById('addItem').addEventListener('click', ()=>{ itemCount++; itensEl.appendChild(createCard('item', itemCount, {nome:'', peso:''})); });
      document.getElementById('addArma').addEventListener('click', ()=>{ armaCount++; armasEl.appendChild(createCard('arma', armaCount, {nome:'', dano:'', bonus:''})); });
      document.getElementById('addMagia').addEventListener('click', ()=>{ magiaCount++; magiasEl.appendChild(createCard('magia', magiaCount, {nome:'', desc:''})); });

      document.getElementById('addEquip').addEventListener('click', ()=>{ equipCount++; equipEl.appendChild(createCard('equip', equipCount, {nome:'', peso:0})); updateCargaValues(); });
      document.getElementById('clearEquip').addEventListener('click', ()=>{ if(confirm('Remover todos os equipamentos?')){ equipEl.innerHTML=''; equipCount=0; updateCargaValues(); } });

      // cria 5 linhas de ataque iniciais
      const attacksTbody = document.getElementById('attacksTbody');
      for(let i=1;i<=5;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="atk-nome" data-i="${i}"></td>
                        <td><input type="number" class="atk-bonus" data-i="${i}" value="0"></td>
                        <td><input type="text" class="atk-dano" data-i="${i}"></td>
                        <td><input type="text" class="atk-crit" data-i="${i}"></td>
                        <td><input type="text" class="atk-tipo" data-i="${i}"></td>
                        <td><input type="text" class="atk-alc" data-i="${i}"></td>`;
        attacksTbody.appendChild(tr);
      }

      // att listeners to update carga when equip changes
      equipEl.addEventListener('input', updateCargaValues);
      document.getElementById('forca').addEventListener('input', updateCargaValues);
      // init carga
      updateCargaValues();

    });

    window._cardsAPI = {
      createCard,
      getAllData: function(){
        const itens = Array.from(document.querySelectorAll('#itens .card')).map(c=>{
          if(c.dataset.type!=='item') return null;
          const name = c.querySelector('.display-name') ? c.querySelector('.display-name').textContent : (c.querySelector('.field-nome')?.value||'');
          const peso = c.querySelector('.display-peso') ? Number(c.querySelector('.display-peso').textContent||0) : Number(c.querySelector('.field-peso')?.value||0);
          return { nome: name, peso: peso };
        }).filter(Boolean);
        const armas = Array.from(document.querySelectorAll('#armas .card')).map(c=>{
          if(c.dataset.type!=='arma') return null;
          const nome = c.querySelector('.display-nome') ? c.querySelector('.display-nome').textContent : (c.querySelector('.field-nome')?.value||'');
          const dano = c.querySelector('.display-dano') ? c.querySelector('.display-dano').textContent : (c.querySelector('.field-dano')?.value||'');
          const bonus = c.querySelector('.display-bonus') ? Number(c.querySelector('.display-bonus').textContent||0) : Number(c.querySelector('.field-bonus')?.value||0);
          return { nome, dano, bonus };
        }).filter(Boolean);
        const magias = Array.from(document.querySelectorAll('#magiasList .card')).map(c=>{
          if(c.dataset.type!=='magia') return null;
          const nome = c.querySelector('.display-nome') ? c.querySelector('.display-nome').textContent : (c.querySelector('.field-nome')?.value||'');
          const desc = c.querySelector('.display-desc') ? c.querySelector('.display-desc').textContent : (c.querySelector('.field-desc')?.value||'');
          return { nome, desc };
        }).filter(Boolean);
        const equips = Array.from(document.querySelectorAll('#equipList .card')).map(c=>{
          if(c.dataset.type!=='equip') return null;
          const nome = c.querySelector('.display-name') ? c.querySelector('.display-name').textContent : (c.querySelector('.field-nome')?.value||'');
          const peso = c.querySelector('.display-peso') ? Number(c.querySelector('.display-peso').textContent||0) : Number(c.querySelector('.field-peso')?.value||0);
          return { nome, peso };
        }).filter(Boolean);

        // ataques
        const ataques = [];
        Array.from(document.querySelectorAll('#attacksTbody tr')).forEach((tr,i)=>{
          const idx = i+1;
          const nome = tr.querySelector('.atk-nome')?.value||'';
          const bonus = Number(tr.querySelector('.atk-bonus')?.value||0);
          const dano = tr.querySelector('.atk-dano')?.value||'';
          const crit = tr.querySelector('.atk-crit')?.value||'';
          const tipo = tr.querySelector('.atk-tipo')?.value||'';
          const alc = tr.querySelector('.atk-alc')?.value||'';
          if(nome||dano||bonus||crit||tipo||alc) ataques.push({ nome, bonus, dano, crit, tipo, alcance:alc });
        });

        return { itens, armas, magias, equips, ataques };
      },
      loadAllData: function(obj){
        const itensEl=document.getElementById('itens'), armasEl=document.getElementById('armas'), magiasEl=document.getElementById('magiasList'), equipEl=document.getElementById('equipList');
        itensEl.innerHTML=''; armasEl.innerHTML=''; magiasEl.innerHTML=''; equipEl.innerHTML='';
        itemCount = armaCount = magiaCount = equipCount = 0;
        if(obj.itens && Array.isArray(obj.itens)){ obj.itens.forEach(it=>{ itemCount++; itensEl.appendChild(createCard('item', itemCount, { nome: it.nome||'', peso: it.peso||'', viewOnly:true })); }); }
        if(obj.armas && Array.isArray(obj.armas)){ obj.armas.forEach(a=>{ armaCount++; armasEl.appendChild(createCard('arma', armaCount, { nome: a.nome||'', dano: a.dano||'', bonus: a.bonus||'', viewOnly:true })); }); }
        if(obj.magias && Array.isArray(obj.magias)){ obj.magias.forEach(m=>{ magiaCount++; magiasEl.appendChild(createCard('magia', magiaCount, { nome: m.nome||'', desc: m.desc||'', viewOnly:true })); }); }
        if(obj.equips && Array.isArray(obj.equips)){ obj.equips.forEach(eq=>{ equipCount++; equipEl.appendChild(createCard('equip', equipCount, { nome: eq.nome||'', peso: eq.peso||'', viewOnly:true })); }); }
        if(obj.ataques && Array.isArray(obj.ataques)){
          const rows = document.querySelectorAll('#attacksTbody tr');
          rows.forEach((tr,i)=>{
            const a = obj.ataques[i];
            if(a){ tr.querySelector('.atk-nome').value = a.nome||''; tr.querySelector('.atk-bonus').value = a.bonus||0; tr.querySelector('.atk-dano').value = a.dano||''; tr.querySelector('.atk-crit').value = a.crit||''; tr.querySelector('.atk-tipo').value = a.tipo||''; tr.querySelector('.atk-alc').value = a.alcance||''; }
          });
        }
        updateCargaValues();
      }
    };
  })();
  </script>

  <!-- script principal (perícias + mods automáticos corrigido + carga) -->
 <script>
(function(){
  // ---------- CONFIG / SKILLS ----------
  const SKILLS = [
    { key:'acro', label:'Acrobacia', attr:'modDes' },
    { key:'ades', label:'Adestramento', attr:'modCar' },
    { key:'atle', label:'Atletismo', attr:'modFor' },
    { key:'atua', label:'Atuação', attr:'modCar' },
    { key:'caval', label:'Cavalgar', attr:'modDes' },
    { key:'conhec', label:'Conhecimento', attr:'modInt' },
    { key:'cura', label:'Cura', attr:'modSab' },
    { key:'dipl', label:'Diplomacia', attr:'modCar' },
    { key:'enga', label:'Enganação', attr:'modCar' },
    { key:'fort', label:'Fortitude', attr:'modCon' },
    { key:'furt', label:'Furtividade', attr:'modDes' },
    { key:'inic', label:'Iniciativa', attr:'modDes' },
    { key:'intu', label:'Intuição', attr:'modSab' },
    { key:'inve', label:'Investigação', attr:'modInt' },
    { key:'joga', label:'Jogatina', attr:'modCar' },
    { key:'ladi', label:'Ladinagem', attr:'modDes' },
    { key:'luta', label:'Luta', attr:'modFor' },
    { key:'mist', label:'Misticismo', attr:'modInt' },
    { key:'nobr', label:'Nobreza', attr:'modInt' },
    { key:'ofi1', label:'Ofício 1', attr:'modInt' },
    { key:'ofi2', label:'Ofício 2', attr:'modInt' },
    { key:'perc', label:'Percepção', attr:'modSab' },
    { key:'pilo', label:'Pilotagem', attr:'modDes' },
    { key:'pont', label:'Pontaria', attr:'modDes' },
    { key:'refl', label:'Reflexos', attr:'modDes' },
    { key:'reli', label:'Religião', attr:'modSab' },
    { key:'sobr', label:'Sobrevivência', attr:'modSab' },
    { key:'vont', label:'Vontade', attr:'modSab' }
  ];

  // ---------- UTIL / VARS ----------
  let itemCount = 0, armaCount = 0, magiaCount = 0, equipCount = 0;
  const ATTR_TO_MOD = {
    forca: 'modFor',
    destreza: 'modDes',
    const: 'modCon',
    int: 'modInt',
    sab: 'modSab',
    car: 'modCar'
  };

  // shortcut elements
  const nivelEl = document.getElementById('nivel');
  const autoModsEl = document.getElementById('autoMods');

  // ---------- CARDS (itens/armas/magias/equips) ----------
  function createCard(type, idx, data = {}) {
    const div = document.createElement('div');
    div.className = 'card small';
    div.dataset.type = type;
    div.dataset.idx = idx;
    const display = document.createElement('div'); const edit = document.createElement('div'); const actions = document.createElement('div');
    display.className='display'; edit.className='edit'; actions.className='card-actions';
    display.style.display = data.viewOnly ? 'flex' : 'none';
    edit.style.display = data.viewOnly ? 'none' : 'block';
    const btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.className='btn sm edit-btn'; btnEdit.textContent = data.viewOnly ? 'Editar' : 'Salvar';
    const btnRemove = document.createElement('button'); btnRemove.type='button'; btnRemove.className='btn sm remove-btn'; btnRemove.textContent='Remover';
    actions.appendChild(btnEdit); actions.appendChild(btnRemove);
    function escapeAttr(v){ if(v===undefined||v===null) return ''; return String(v).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeHtml(v){ if(v===undefined||v===null) return ''; return String(v).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    if(type==='item'){ const nome=data.nome||''; const peso=data.peso||''; display.innerHTML = `<div class="display-row"><div class="label">Item</div><div><strong class="display-name">${escapeHtml(nome)}</strong></div><div class="label">Peso</div><div><span class="display-peso">${escapeHtml(String(peso))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Item" value="${escapeAttr(nome)}"><input type="number" class="field-peso" placeholder="Peso" value="${escapeAttr(peso)}"></div>`; }
    if(type==='arma'){ const nome=data.nome||''; const dano=data.dano||''; const bonus=data.bonus||''; display.innerHTML = `<div class="display-row"><div class="label">Nome</div><div><strong class="display-nome">${escapeHtml(nome)}</strong></div><div class="label">Dano</div><div><span class="display-dano">${escapeHtml(dano)}</span></div><div class="label">Bônus</div><div><span class="display-bonus">${escapeHtml(String(bonus))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Nome da Arma" value="${escapeAttr(nome)}"><input type="text" class="field-dano" placeholder="Dano" value="${escapeAttr(dano)}"><input type="number" class="field-bonus" placeholder="Bônus" value="${escapeAttr(bonus)}"></div>`; }
    if(type==='magia'){ const nome=data.nome||''; const desc=data.desc||''; display.innerHTML = `<div class="display-row"><div class="label">Magia</div><div><strong class="display-nome">${escapeHtml(nome)}</strong></div><div style="width:100%;margin-top:6px"><div class="label">Efeito</div><div class="display-desc">${escapeHtml(desc)}</div></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-direction:column"><input type="text" class="field-nome" placeholder="Nome da Magia" value="${escapeAttr(nome)}"><textarea class="field-desc" placeholder="Efeitos">${escapeAttr(desc)}</textarea></div>`; }
    if(type==='equip'){ const nome=data.nome||''; const peso=data.peso||''; display.innerHTML = `<div class="display-row"><div class="label">Equip</div><div><strong class="display-name">${escapeHtml(nome)}</strong></div><div class="label">Peso</div><div><span class="display-peso">${escapeHtml(String(peso))}</span></div></div>`; edit.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="field-nome" placeholder="Equipamento" value="${escapeAttr(nome)}"><input type="number" class="field-peso" placeholder="Peso" value="${escapeAttr(peso)}"></div>`; }

    div.appendChild(display); div.appendChild(edit); div.appendChild(actions);
    btnEdit.addEventListener('click', ()=>{ const isEditing = edit.style.display !== 'none'; if(isEditing){ if(type==='item' || type==='equip'){ const nomeVal = div.querySelector('.field-nome').value||''; const pesoVal = div.querySelector('.field-peso').value||''; div.querySelector('.display-name').textContent = nomeVal; div.querySelector('.display-peso').textContent = pesoVal; } if(type==='arma'){ const nomeVal = div.querySelector('.field-nome').value||''; const danoVal = div.querySelector('.field-dano').value||''; const bonusVal = div.querySelector('.field-bonus').value||''; div.querySelector('.display-nome').textContent = nomeVal; div.querySelector('.display-dano').textContent = danoVal; div.querySelector('.display-bonus').textContent = bonusVal; } if(type==='magia'){ const nomeVal = div.querySelector('.field-nome').value||''; const descVal = div.querySelector('.field-desc').value||''; div.querySelector('.display-nome').textContent = nomeVal; div.querySelector('.display-desc').textContent = descVal; } edit.style.display='none'; display.style.display='flex'; btnEdit.textContent='Editar'; updateCargaValues(); } else { edit.style.display='block'; display.style.display='none'; btnEdit.textContent='Salvar'; } });
    btnRemove.addEventListener('click', ()=>{ if(confirm('Remover este '+type+'?')) { div.remove(); updateCargaValues(); } });
    return div;
  }

  // ---------- INIT DOMContentLoaded: cria botões/cards/ataques ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    const itensEl=document.getElementById('itens'), armasEl=document.getElementById('armas'), magiasEl=document.getElementById('magiasList'), equipEl=document.getElementById('equipList');

    document.getElementById('addItem').addEventListener('click', ()=>{ itemCount++; itensEl.appendChild(createCard('item', itemCount, {nome:'', peso:''})); });
    document.getElementById('addArma').addEventListener('click', ()=>{ armaCount++; armasEl.appendChild(createCard('arma', armaCount, {nome:'', dano:'', bonus:''})); });
    document.getElementById('addMagia').addEventListener('click', ()=>{ magiaCount++; magiasEl.appendChild(createCard('magia', magiaCount, {nome:'', desc:''})); });

    document.getElementById('addEquip').addEventListener('click', ()=>{ equipCount++; equipEl.appendChild(createCard('equip', equipCount, {nome:'', peso:0})); updateCargaValues(); });
    document.getElementById('clearEquip').addEventListener('click', ()=>{ if(confirm('Remover todos os equipamentos?')){ equipEl.innerHTML=''; equipCount=0; updateCargaValues(); } });

    // cria 5 linhas de ataque iniciais
    const attacksTbody = document.getElementById('attacksTbody');
    for(let i=1;i<=5;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input type="text" class="atk-nome" data-i="${i}"></td>
                      <td><input type="number" class="atk-bonus" data-i="${i}" value="0"></td>
                      <td><input type="text" class="atk-dano" data-i="${i}"></td>
                      <td><input type="text" class="atk-crit" data-i="${i}"></td>
                      <td><input type="text" class="atk-tipo" data-i="${i}"></td>
                      <td><input type="text" class="atk-alc" data-i="${i}"></td>`;
      attacksTbody.appendChild(tr);
    }

    // listeners iniciais
    const equipListEl = document.getElementById('equipList');
    equipListEl.addEventListener('input', updateCargaValues);
    const forEl = document.getElementById('forca');
    if(forEl) forEl.addEventListener('input', updateCargaValues);

    // inicializa perícias (se o container existir, renderiza linhas)
    initSkillsArea();

    // inicializa valores dependentes
    maybeAutoCalcMods();
    recalcAll();
    updateCargaValues();
  });

  // ---------- CARDS API ----------
  window._cardsAPI = {
    createCard,
    getAllData: function(){
      const itens = Array.from(document.querySelectorAll('#itens .card')).map(c=>{
        if(c.dataset.type!=='item') return null;
        const name = c.querySelector('.display-name') ? c.querySelector('.display-name').textContent : (c.querySelector('.field-nome')?.value||'');
        const peso = c.querySelector('.display-peso') ? Number(c.querySelector('.display-peso').textContent||0) : Number(c.querySelector('.field-peso')?.value||0);
        return { nome: name, peso: peso };
      }).filter(Boolean);
      const armas = Array.from(document.querySelectorAll('#armas .card')).map(c=>{
        if(c.dataset.type!=='arma') return null;
        const nome = c.querySelector('.display-nome') ? c.querySelector('.display-nome').textContent : (c.querySelector('.field-nome')?.value||'');
        const dano = c.querySelector('.display-dano') ? c.querySelector('.display-dano').textContent : (c.querySelector('.field-dano')?.value||'');
        const bonus = c.querySelector('.display-bonus') ? Number(c.querySelector('.display-bonus').textContent||0) : Number(c.querySelector('.field-bonus')?.value||0);
        return { nome, dano, bonus };
      }).filter(Boolean);
      const magias = Array.from(document.querySelectorAll('#magiasList .card')).map(c=>{
        if(c.dataset.type!=='magia') return null;
        const nome = c.querySelector('.display-nome') ? c.querySelector('.display-nome').textContent : (c.querySelector('.field-nome')?.value||'');
        const desc = c.querySelector('.display-desc') ? c.querySelector('.display-desc').textContent : (c.querySelector('.field-desc')?.value||'');
        return { nome, desc };
      }).filter(Boolean);
      const equips = Array.from(document.querySelectorAll('#equipList .card')).map(c=>{
        if(c.dataset.type!=='equip') return null;
        const nome = c.querySelector('.display-name') ? c.querySelector('.display-name').textContent : (c.querySelector('.field-nome')?.value||'');
        const peso = c.querySelector('.display-peso') ? Number(c.querySelector('.display-peso').textContent||0) : Number(c.querySelector('.field-peso')?.value||0);
        return { nome, peso };
      }).filter(Boolean);

      // ataques
      const ataques = [];
      Array.from(document.querySelectorAll('#attacksTbody tr')).forEach((tr,i)=>{
        const idx = i+1;
        const nome = tr.querySelector('.atk-nome')?.value||'';
        const bonus = Number(tr.querySelector('.atk-bonus')?.value||0);
        const dano = tr.querySelector('.atk-dano')?.value||'';
        const crit = tr.querySelector('.atk-crit')?.value||'';
        const tipo = tr.querySelector('.atk-tipo')?.value||'';
        const alc = tr.querySelector('.atk-alc')?.value||'';
        if(nome||dano||bonus||crit||tipo||alc) ataques.push({ nome, bonus, dano, crit, tipo, alcance:alc });
      });

      return { itens, armas, magias, equips, ataques };
    },
    loadAllData: function(obj){
      const itensEl=document.getElementById('itens'), armasEl=document.getElementById('armas'), magiasEl=document.getElementById('magiasList'), equipEl=document.getElementById('equipList');
      itensEl.innerHTML=''; armasEl.innerHTML=''; magiasEl.innerHTML=''; equipEl.innerHTML='';
      itemCount = armaCount = magiaCount = equipCount = 0;
      if(obj.itens && Array.isArray(obj.itens)){ obj.itens.forEach(it=>{ itemCount++; itensEl.appendChild(createCard('item', itemCount, { nome: it.nome||'', peso: it.peso||'', viewOnly:true })); }); }
      if(obj.armas && Array.isArray(obj.armas)){ obj.armas.forEach(a=>{ armaCount++; armasEl.appendChild(createCard('arma', armaCount, { nome: a.nome||'', dano: a.dano||'', bonus: a.bonus||'', viewOnly:true })); }); }
      if(obj.magias && Array.isArray(obj.magias)){ obj.magias.forEach(m=>{ magiaCount++; magiasEl.appendChild(createCard('magia', magiaCount, { nome: m.nome||'', desc: m.desc||'', viewOnly:true })); }); }
      if(obj.equips && Array.isArray(obj.equips)){ obj.equips.forEach(eq=>{ equipCount++; equipEl.appendChild(createCard('equip', equipCount, { nome: eq.nome||'', peso: eq.peso||'', viewOnly:true })); }); }
      if(obj.ataques && Array.isArray(obj.ataques)){
        const rows = document.querySelectorAll('#attacksTbody tr');
        rows.forEach((tr,i)=>{
          const a = obj.ataques[i];
          if(a){ tr.querySelector('.atk-nome').value = a.nome||''; tr.querySelector('.atk-bonus').value = a.bonus||0; tr.querySelector('.atk-dano').value = a.dano||''; tr.querySelector('.atk-crit').value = a.crit||''; tr.querySelector('.atk-tipo').value = a.tipo||''; tr.querySelector('.atk-alc').value = a.alcance||''; }
        });
      }
      updateCargaValues();
    }
  };

  // ---------- PERÍCIAS: init / render ----------
  function initSkillsArea(){
    const container = document.getElementById('skillsContainer');
    if(!container) return;
    container.innerHTML = '';
    SKILLS.forEach(s=>{
      const row = document.createElement('div');
      row.className = 'skill-row';
      row.id = 'skill_' + s.key;

      const nameDiv = document.createElement('div');
      nameDiv.innerHTML = `<div class="name">${s.label}</div><div class="tiny muted">${s.attr.replace('mod','').toUpperCase()}</div>`;
      row.appendChild(nameDiv);

      const selWrap = document.createElement('div');
      selWrap.style.display = 'flex';
      selWrap.style.flexDirection = 'column';
      selWrap.innerHTML =
        `<select class="attrSelect" data-key="${s.key}" title="Atributo usado">
           <option value="${s.attr}">Padrão (${s.attr.replace('mod','').toUpperCase()})</option>
           <option value="modFor">For</option>
           <option value="modDes">Des</option>
           <option value="modCon">Con</option>
           <option value="modInt">Int</option>
           <option value="modSab">Sab</option>
           <option value="modCar">Car</option>
           <option value="other">Outro</option>
         </select>
         <input type="number" class="customAttr tiny" data-key="${s.key}" placeholder="Outro mod" style="display:none;margin-top:6px;padding:6px;height:34px">`;
      row.appendChild(selWrap);

      const trainedWrap = document.createElement('div');
      trainedWrap.style.display = 'flex';
      trainedWrap.style.alignItems = 'center';
      trainedWrap.innerHTML = `<label class="tiny"><input type="checkbox" class="trained" data-key="${s.key}"> Trein.</label>`;
      row.appendChild(trainedWrap);

      const extraWrap = document.createElement('div');
      extraWrap.innerHTML = `<input type="number" class="extra" data-key="${s.key}" value="0" title="Outros modificadores">`;
      row.appendChild(extraWrap);

      const attrWrap = document.createElement('div');
      attrWrap.innerHTML = `<input type="number" class="attrmod" data-attr="${s.attr}" data-key="${s.key}" value="0" readonly title="Modificador de atributo usado">`;
      row.appendChild(attrWrap);

      const totalWrap = document.createElement('div');
      totalWrap.innerHTML = `<input type="number" class="total" data-key="${s.key}" value="0" readonly title="Total da perícia">`;
      row.appendChild(totalWrap);

      container.appendChild(row);
    });

    // Delegated listeners (container-level)
    container.addEventListener('change', (e)=>{
      if(e.target.matches('.attrSelect')){
        const row = document.getElementById('skill_' + e.target.dataset.key);
        const custom = row.querySelector('.customAttr');
        if(e.target.value === 'other'){
          custom.style.display = 'block';
        } else {
          custom.style.display = 'none';
        }
        recalcAllSkills();
      } else if(e.target.matches('.trained')){
        recalcAllSkills();
      }
    });

    container.addEventListener('input', (e)=>{
      if(e.target.matches('.customAttr') || e.target.matches('.extra')){
        recalcAllSkills();
      }
    });

    // if global attributes change, recalc skills
    Object.values(ATTR_TO_MOD).forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', recalcAllSkills);
    });
    if(nivelEl) nivelEl.addEventListener('input', recalcAllSkills);
  }

  // ---------- MODS automáticos ----------
  function getModifierFromScore(score){
    score = Number(score) || 0;
    if(score <= 1) return -5;
    if(score <= 3) return -4;
    if(score <= 5) return -3;
    if(score <= 7) return -2;
    if(score <= 9) return -1;
    if(score <= 11) return 0;
    if(score <= 13) return 1;
    if(score <= 15) return 2;
    if(score <= 17) return 3;
    if(score <= 19) return 4;
    if(score <= 21) return 5;
    if(score <= 23) return 6;
    if(score <= 25) return 7;
    return 7 + Math.floor((score - 25) / 2);
  }

  function maybeAutoCalcMods(){
    const auto = !!(autoModsEl && autoModsEl.checked);
    Object.keys(ATTR_TO_MOD).forEach(attrId=>{
      const score = Number(document.getElementById(attrId).value || 0);
      const modId = ATTR_TO_MOD[attrId];
      const modEl = document.getElementById(modId);
      if(!modEl) return;
      if(auto){
        modEl.value = getModifierFromScore(score);
        modEl.setAttribute('readonly','');
      } else {
        modEl.removeAttribute('readonly');
      }
    });
  }

  // ---------- PERÍCIAS: cálculos ----------
  function halfLevel(){
    return Math.floor(Number(nivelEl?.value || 1) / 2);
  }

  function updateAttrModsForSkills(){
    SKILLS.forEach(s=>{
      const row = document.getElementById('skill_' + s.key);
      if(!row) return;
      const sel = row.querySelector('.attrSelect');
      const attrmodEl = row.querySelector('.attrmod');
      if(!sel || !attrmodEl) return;
      if(sel.value === 'other'){
        const custom = Number(row.querySelector('.customAttr').value || 0);
        attrmodEl.value = custom;
      } else {
        const global = document.getElementById(sel.value);
        attrmodEl.value = global ? Number(global.value || 0) : 0;
      }
    });
  }

  function recalcAllSkills(){
    updateAttrModsForSkills();
    const half = halfLevel();
    SKILLS.forEach(s=>{
      const row = document.getElementById('skill_' + s.key);
      if(!row) return;
      const trained = !!row.querySelector('.trained').checked;
      const extra = Number(row.querySelector('.extra').value || 0);
      const attr = Number(row.querySelector('.attrmod').value || 0);
      let total = attr + extra;
      if(trained){
        total += half + 2;
      }
      row.querySelector('.total').value = total;
    });
  }

  // ---------- Cálculo global (atributos/perícias/carga) ----------
  function updateAttrModsFromScores(){
    // atualiza campos attrmod (padrão) com base nos valores dos atributos (quando autoMods ativo)
    maybeAutoCalcMods();
  }

  function recalcAll(){
    // manter compatibilidade: atualiza mods automáticos, perícias e carga
    updateAttrModsForSkills(); // garante que attrmod esteja atualizado com selects
    recalcAllSkills();
    updateCargaValues();
  }

  // ---------- Carga / Equip ----------
  function updateCargaValues(){
    const forca = Number(document.getElementById('forca').value||10);
    const cargaMax = forca * 3;
    const levantar = forca * 10;
    const cargaMaxEl = document.getElementById('cargaMax');
    const levantarEl = document.getElementById('levantar');
    if(cargaMaxEl) cargaMaxEl.value = cargaMax;
    if(levantarEl) levantarEl.value = levantar;

    // soma pesos dos equipamentos
    const items = Array.from(document.querySelectorAll('#equipList .card')).map(c=>{
      const pesoEl = c.querySelector('.display-peso') || c.querySelector('.field-peso');
      const peso = pesoEl ? Number(pesoEl.textContent || pesoEl.value || 0) : 0;
      return peso;
    });
    const total = items.reduce((s,n)=>s + (Number(n)||0),0);
    const cargaTotalEl = document.getElementById('cargaTotal');
    if(cargaTotalEl) cargaTotalEl.value = total;

    const penEl = document.getElementById('penalCarga');
    if(penEl){
      if(total > cargaMax){
        penEl.value = '-2 (sobrepeso) — Desloc. reduzido em 3m';
      } else {
        penEl.value = 'Nenhuma';
      }
    }
  }

  // ---------- Public loader for skills (used by JSON loader) ----------
  window.loadSkillsFromData = function(skillsData){
    if(!skillsData) return;
    Object.keys(skillsData).forEach(k=>{
      const sdat = skillsData[k];
      const row = document.getElementById('skill_' + k);
      if(!row) return;
      const sel = row.querySelector('.attrSelect');
      const custom = row.querySelector('.customAttr');

      const choice = sdat && (sdat.attrChoice || sdat.attr);
      if(choice && sel){
        const opts = Array.from(sel.options).map(o=>o.value);
        if(opts.includes(choice)){
          sel.value = choice;
          custom.style.display = (choice === 'other') ? 'block' : 'none';
        } else {
          sel.value = 'other';
          custom.style.display = 'block';
        }
      }

      if(sdat.customAttr !== undefined && row.querySelector('.customAttr')) {
        row.querySelector('.customAttr').value = sdat.customAttr;
      } else if(sdat.attrmod !== undefined && row.querySelector('.customAttr')) {
        row.querySelector('.customAttr').value = sdat.attrmod;
      }

      if(sdat.trained !== undefined) row.querySelector('.trained').checked = !!sdat.trained;
      if(sdat.extra !== undefined) row.querySelector('.extra').value = sdat.extra;
    });
    try{ recalcAllSkills(); }catch(e){ try{ recalcAll(); }catch(_){} }
  };

  // ---------- SALVAR / CARREGAR / GATHER ----------
  function gatherData(){
    const cardsData = window._cardsAPI && window._cardsAPI.getAllData ? window._cardsAPI.getAllData() : {itens:[],armas:[],magias:[],equips:[],ataques:[]};
    const data = {
      meta: {
        nome: document.getElementById('nome')?.value || '',
        jogador: document.getElementById('jogador')?.value || '',
        raca: document.getElementById('raca')?.value || ''
      },
      nivel: Number(document.getElementById('nivel')?.value || 1),
      atributos: {
        forca: Number(document.getElementById('forca')?.value || 10),
        destreza: Number(document.getElementById('destreza')?.value || 10),
        constit: Number(document.getElementById('const')?.value || 10),
        intel: Number(document.getElementById('int')?.value || 10),
        sab: Number(document.getElementById('sab')?.value || 10),
        car: Number(document.getElementById('car')?.value || 10)
      },
      mods: {
        modFor: Number(document.getElementById('modFor')?.value || 0),
        modDes: Number(document.getElementById('modDes')?.value || 0),
        modCon: Number(document.getElementById('modCon')?.value || 0),
        modInt: Number(document.getElementById('modInt')?.value || 0),
        modSab: Number(document.getElementById('modSab')?.value || 0),
        modCar: Number(document.getElementById('modCar')?.value || 0)
      },
      pvs: {
        max: Number(document.getElementById('pvsMax')?.value||0),
        atual: Number(document.getElementById('pvsAtual')?.value||0)
      },
      pms: {
        max: Number(document.getElementById('pmsMax')?.value||0),
        atual: Number(document.getElementById('pmsAtual')?.value||0)
      },
      defesa: {
        caTotal: Number(document.getElementById('caTotal')?.value||0),
        caBase: Number(document.getElementById('caBase')?.value||0),
        bonusArm: Number(document.getElementById('bonusArm')?.value||0),
        bonusEsc: Number(document.getElementById('bonusEsc')?.value||0),
        penalidadeArm: Number(document.getElementById('penalidadeArm')?.value||0),
        outrosDef: Number(document.getElementById('outrosDef')?.value||0),
        armaduraNome: document.getElementById('armaduraNome')?.value||'',
        pArmadura: Number(document.getElementById('pArmadura')?.value||0),
        escudoNome: document.getElementById('escudoNome')?.value||'',
        pEscudo: Number(document.getElementById('pEscudo')?.value||0),
        proficiencias: document.getElementById('proficiencias')?.value||'',
        tamanho: document.getElementById('tamanho')?.value||'Médio',
        desloc: Number(document.getElementById('desloc')?.value||0)
      },
      skills: {},
      cards: cardsData,
      autoMods: !!(autoModsEl && autoModsEl.checked),
      carga: {
        cargaMax: Number(document.getElementById('cargaMax')?.value||0),
        levantar: Number(document.getElementById('levantar')?.value||0),
        cargaTotal: Number(document.getElementById('cargaTotal')?.value||0),
        penalCarga: document.getElementById('penalCarga')?.value||''
      }
    };

    // skills: salvar escolha de atributo (attrChoice), customAttr e demais campos
    SKILLS.forEach(s=>{
      const row = document.getElementById('skill_'+s.key);
      if(!row) return;
      const sel = row.querySelector('.attrSelect');
      const attrChoice = sel ? sel.value : s.attr;
      const customAttr = row.querySelector('.customAttr') ? Number(row.querySelector('.customAttr').value || 0) : undefined;
      const attrmod = Number(row.querySelector('.attrmod')?.value || 0);
      data.skills[s.key] = {
        label: s.label,
        attr: s.attr,
        attrChoice: attrChoice,
        customAttr: customAttr,
        trained: !!row.querySelector('.trained')?.checked,
        extra: Number(row.querySelector('.extra')?.value || 0),
        attrmod: attrmod,
        total: Number(row.querySelector('.total')?.value || 0)
      };
    });

    // ataques explicit
    data.ataques = [];
    Array.from(document.querySelectorAll('#attacksTbody tr')).forEach((tr,i)=>{
      const nome = tr.querySelector('.atk-nome')?.value||'';
      const bonus = Number(tr.querySelector('.atk-bonus')?.value||0);
      const dano = tr.querySelector('.atk-dano')?.value||'';
      const crit = tr.querySelector('.atk-crit')?.value||'';
      const tipo = tr.querySelector('.atk-tipo')?.value||'';
      const alc = tr.querySelector('.atk-alc')?.value||'';
      if(nome||dano||bonus||crit||tipo||alc) data.ataques.push({ nome, bonus, dano, crit, tipo, alcance:alc });
    });

    // mantém snapshot para uso por outros scripts (ex: PDF)
    window.__lastGather_data_cache = data;
    window.gatherData = function(){ return JSON.parse(JSON.stringify(window.__lastGather_data_cache || data)); };

    return data;
  }

  // ---------- EVENTOS: SALVAR / CARREGAR JSON ----------
  document.getElementById('btnSave').addEventListener('click', ()=> {
    const data = gatherData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (document.getElementById('nome')?.value || 'ficha') + '.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('btnLoad').addEventListener('click', ()=> document.getElementById('fileLoader').click());
  document.getElementById('fileLoader').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);

      if(data.nivel) document.getElementById('nivel').value = data.nivel;
      if(data.atributos){
        if(data.atributos.forca !== undefined) document.getElementById('forca').value = data.atributos.forca;
        if(data.atributos.destreza !== undefined) document.getElementById('destreza').value = data.atributos.destreza;
        if(data.atributos.constit !== undefined) document.getElementById('const').value = data.atributos.constit;
        if(data.atributos.intel !== undefined) document.getElementById('int').value = data.atributos.intel;
        if(data.atributos.sab !== undefined) document.getElementById('sab').value = data.atributos.sab;
        if(data.atributos.car !== undefined) document.getElementById('car').value = data.atributos.car;
      }
      if(data.mods){
        Object.keys(data.mods).forEach(k=>{
          const el = document.getElementById(k);
          if(el) el.value = data.mods[k];
        });
      }
      if(data.pvs){
        if(data.pvs.max!==undefined) document.getElementById('pvsMax').value = data.pvs.max;
        if(data.pvs.atual!==undefined) document.getElementById('pvsAtual').value = data.pvs.atual;
      }
      if(data.pms){
        if(data.pms.max!==undefined) document.getElementById('pmsMax').value = data.pms.max;
        if(data.pms.atual!==undefined) document.getElementById('pmsAtual').value = data.pms.atual;
      }
      if(data.defesa){
        Object.keys(data.defesa).forEach(k=>{
          const el = document.getElementById(k);
          if(el) el.value = data.defesa[k];
        });
      }

      // skills: usa o loader público (mais robusto)
      if(data.skills){
        if(window.loadSkillsFromData){
          window.loadSkillsFromData(data.skills);
        } else {
          // fallback mínimo
          Object.keys(data.skills).forEach(sk=>{
            const sdata = data.skills[sk];
            const row = document.getElementById('skill_'+sk);
            if(row){
              if(sdata.trained !== undefined) row.querySelector('.trained').checked = !!sdata.trained;
              if(sdata.extra !== undefined) row.querySelector('.extra').value = sdata.extra;
              if(sdata.attrmod !== undefined) row.querySelector('.attrmod').value = sdata.attrmod;
              if(sdata.customAttr !== undefined && row.querySelector('.customAttr')) row.querySelector('.customAttr').value = sdata.customAttr;
            }
          });
        }
      }

      if(data.ataques){
        const rows = document.querySelectorAll('#attacksTbody tr');
        rows.forEach((tr,i)=>{
          const a = data.ataques[i];
          if(a){ tr.querySelector('.atk-nome').value = a.nome||''; tr.querySelector('.atk-bonus').value = a.bonus||0; tr.querySelector('.atk-dano').value = a.dano||''; tr.querySelector('.atk-crit').value = a.crit||''; tr.querySelector('.atk-tipo').value = a.tipo||''; tr.querySelector('.atk-alc').value = a.alcance||''; }
        });
      }
      if(data.cards && window._cardsAPI && window._cardsAPI.loadAllData) window._cardsAPI.loadAllData(data.cards);
      if(data.autoMods && autoModsEl) autoModsEl.checked = !!data.autoMods;

      // recalc geral
      maybeAutoCalcMods();
      recalcAll();
      alert('Ficha carregada.');
    }catch(err){
      alert('Erro ao carregar JSON: ' + err.message);
    } finally { e.target.value = ''; }
  });

  // ---------- Interações e recalculadores vinculados ----------
  // watchers para inputs numéricos: recalcula ao alterar
  document.addEventListener('input', (e)=>{
    if(!e.target) return;
    const t = e.target;
    if(t.matches('#sheet input[type="number"], #sheet input[type="text"], #sheet select')) {
      // evita recalc a cada tecla para campos grandes, mas é ok
      recalcAll();
    }
  });

  if(autoModsEl) autoModsEl.addEventListener('change', ()=>{ maybeAutoCalcMods(); recalcAll(); });
  if(nivelEl) nivelEl.addEventListener('input', ()=>{ recalcAll(); });

  // recalcula periodicamente (segurança)
  setInterval(recalcAll, 1000);

  // ---------- Carga / Força listener ----------
  const forEl = document.getElementById('forca');
  if(forEl) forEl.addEventListener('input', updateCargaValues);

  // ---------- util export público ----------
  window.gatherData = gatherData;

  // ---------- PDF / preenchimento (preserva seu código inicial) ----------
  // não alterei a rotina de PDF (assumir que seu script externo usa window.gatherData)
  // se quiser que eu integre mudanças no fillPdfFromForm diga que parte deseja ajustar.

})();
</script>


  <!-- PDF-lib (mantido) e script para preenchimento inteligente -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
  (function(){
    let originalPdf = null;
    const statusEl = document.getElementById('pdfStatus');

    document.getElementById("fileLoaderPdf").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) { statusEl.textContent = 'Nenhum PDF selecionado'; return; }
      try{
        originalPdf = await file.arrayBuffer();
        statusEl.textContent = 'PDF carregado: ' + file.name;
      }catch(err){
        statusEl.textContent = 'Erro ao carregar PDF';
      }
    });

    function findAndSetText(form, candidates, text){
      // candidates: array de possíveis nomes/parciais; tenta encontrar campo cujo nome contenha candidato
      const fields = form.getFields();
      for(const c of candidates){
        const lower = String(c).toLowerCase().trim();
        for(const f of fields){
          const n = String(f.getName()).toLowerCase();
          if(n === lower || n.indexOf(lower) !== -1 || lower.indexOf(n) !== -1){
            try{
              // Tentativa de setText se for TextField
              if(typeof f.setText === 'function') { f.setText(String(text)); return true; }
            }catch(e){ /* ignore */ }
          }
        }
      }
      return false;
    }

    // heurística: mapeia vários campos comuns do PDF (com base no PDF enviado). Se um campo não existir, tentamos alternativas.
    async function fillPdfFromForm(pdfBytes){
      const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
      const form = pdfDoc.getForm();
      // Dados do form html
      const dataJson = (window && window._lastGathered) ? window._lastGathered : null;
      // se não tiver, gera agora
      const gather = window && window.__gatherDataInline ? window.__gatherDataInline : null;

      // Use gatherData direto (evita dependência externa)
      const getData = () => {
        try{
          return (typeof window !== 'undefined' && window.gatherData) ? window.gatherData() : null;
        }catch(e){ return null; }
      };

      const data = getData() || (window && window._lastGathered) || (function(){ return {}; })();

      // campo auxiliar para escrever vários candidatos
      const S = (arr)=>Array.isArray(arr)?arr:[arr];

      // Mapeamentos exemplares — tentamos várias alternativas de nome
      // IDENTIFICAÇÃO
      findAndSetText(form, S(['NOME DO PERSONAGEM','NOME','nome do personagem','PERSONAGEM']), document.getElementById('nome').value || '');
      findAndSetText(form, S(['JOGADOR','JOGADOR:','jogador']), document.getElementById('jogador').value || '');
      findAndSetText(form, S(['RAÇA','RACA','RACA:']), document.getElementById('raca').value || '');
      findAndSetText(form, S(['ORIGEM','ORIGEM:']), document.getElementById('origem').value || '');
      findAndSetText(form, S(['CLASSE','CLASSE:']), document.getElementById('classe').value || '');
      findAndSetText(form, S(['Lv','LV','NÍVEL','NIVEL']), document.getElementById('nivel').value || '');
      findAndSetText(form, S(['DIVINDADE','DIVINDADE']), document.getElementById('divindade').value || '');

      // ATRIBUTOS (muitos PDFs usam nomes simples como For, Des, Int, etc.)
      findAndSetText(form, S(['For','FOR','Força','FORCA','FOR:','For:']), document.getElementById('forca').value || '');
      findAndSetText(form, S(['ModFor','ModFor:','modfor']), document.getElementById('modFor').value || '');
      findAndSetText(form, S(['Des','DES','Des:','Destreza','DESTREZA']), document.getElementById('destreza').value || '');
      findAndSetText(form, S(['ModDes','modDes','ModDes:']), document.getElementById('modDes').value || '');
      findAndSetText(form, S(['Con','CON','Con:','Constituição','CONST','CONSTIT']), document.getElementById('const').value || '');
      findAndSetText(form, S(['ModCon','modCon','ModCon:']), document.getElementById('modCon').value || '');
      findAndSetText(form, S(['Int','INT','Int:']), document.getElementById('int').value || '');
      findAndSetText(form, S(['ModInt','modInt']), document.getElementById('modInt').value || '');
      findAndSetText(form, S(['Sab','SAB','Sab:']), document.getElementById('sab').value || '');
      findAndSetText(form, S(['ModSab','modSab']), document.getElementById('modSab').value || '');
      findAndSetText(form, S(['Car','CAR','Car:']), document.getElementById('car').value || '');
      findAndSetText(form, S(['ModCar','modCar']), document.getElementById('modCar').value || '');

      // PV / PM
      findAndSetText(form, S(['PVs Totais','PVs Totais:','PVs Totais','PVsTotais','PVsMax','PVSTOTAIS','pvs max']), document.getElementById('pvsMax').value || '');
      findAndSetText(form, S(['PVs Atuais','PVs Atuais:','pvs atual','pvsAtual']), document.getElementById('pvsAtual').value || '');
      findAndSetText(form, S(['PMs Totais','PMs Totais:','pms max','pmsMax']), document.getElementById('pmsMax').value || '');
      findAndSetText(form, S(['PMs Atuais','PMs Atuais:','pms atual','pmsAtual']), document.getElementById('pmsAtual').value || '');

      // ATAQUES (tentamos mapear até 5 slots; nomes no PDF podem ser "Ataque 1", "Bônus Atq 1", etc.)
      for(let i=1;i<=5;i++){
        const row = document.querySelector(`#attacksTbody tr:nth-child(${i})`);
        if(!row) continue;
        const nome = row.querySelector('.atk-nome')?.value||'';
        const bonus = row.querySelector('.atk-bonus')?.value||'';
        const dano = row.querySelector('.atk-dano')?.value||'';
        const crit = row.querySelector('.atk-crit')?.value||'';
        const tipo = row.querySelector('.atk-tipo')?.value||'';
        const alc = row.querySelector('.atk-alc')?.value||'';
        // várias alternativas de nome de campo conforme PDF
        findAndSetText(form, S([`Ataque ${i}`, `Ataque ${i}:`, `Ataque${i}`, `ATAQUE ${i}`]), nome);
        findAndSetText(form, S([`Bônus Atq ${i}`, `Bonus Atq ${i}`, `BônusAtq${i}`, `Bônus Atq ${i}:`]), bonus);
        findAndSetText(form, S([`Dano ${i}`, `Dano ${i}:`, `DANO ${i}`]), dano);
        findAndSetText(form, S([`Crítico ${i}`, `Crítico ${i}:`, `Crit ${i}`]), crit);
        findAndSetText(form, S([`Tipo ${i}`, `Tipo ${i}:`]), tipo);
        findAndSetText(form, S([`Alcance ${i}`, `Alcance ${i}:`]), alc);
      }

      // DEFESA / ARMADURA
      findAndSetText(form, S(['CA','CA:','CA Total','CA Total:','CA: 10']), document.getElementById('caTotal').value || '');
      findAndSetText(form, S(['Base CA','BaseCA','Base CA:','Base CA']), document.getElementById('caBase').value || '');
      findAndSetText(form, S(['Bônus de Armadura','Bonus de Armadura','bonusArm','Bônus Armadura']), document.getElementById('bonusArm').value || '');
      findAndSetText(form, S(['Bônus de Escudo','Bonus de Escudo','bonusEsc','Bônus Escudo']), document.getElementById('bonusEsc').value || '');
      findAndSetText(form, S(['Penalidade de Armadura','penalidadeArm']), document.getElementById('penalidadeArm').value || '');
      findAndSetText(form, S(['Armadura','Armadura:','armaduraNome']), document.getElementById('armaduraNome').value || '');
      findAndSetText(form, S(['Escudo','Escudo:','escudoNome']), document.getElementById('escudoNome').value || '');
      findAndSetText(form, S(['Proficiências','Proficiências','proficiencias']), document.getElementById('proficiencias').value || '');

      // TAMANHO / DESLOCAMENTO
      findAndSetText(form, S(['SeleTamanho','Tamanho','TAMANHO','SeleTamanho']), document.getElementById('tamanho').value || '');
      findAndSetText(form, S(['Desloc','Deslocamento','Desloc:','Deslocamento (m)']), document.getElementById('desloc').value || '');

      // EQUIPAMENTOS: tentamos preencher itens sequenciais do PDF Item1..Item15
      const equips = Array.from(document.querySelectorAll('#equipList .card')).map(c=>({
        nome: c.querySelector('.display-name')?.textContent||c.querySelector('.field-nome')?.value||'',
        peso: c.querySelector('.display-peso')?.textContent||c.querySelector('.field-peso')?.value||'0'
      }));
      equips.slice(0,15).forEach((eq,i)=>{
        const idx = i+1;
        findAndSetText(form, S([`Item${idx}`, `Item ${idx}`, `Item ${idx}:`, `Item${idx}:`]), eq.nome);
        findAndSetText(form, S([`PesoItem${idx}`, `PesoItem ${idx}`, `Peso Item ${idx}`]), eq.peso);
      });

      // Carga maxima / levantar
      findAndSetText(form, S(['CargaMax','CargaMax:','Carga Máxima','Carga Máxima:']), document.getElementById('cargaMax').value || '');
      findAndSetText(form, S(['Levantar','Levantar:','Levantar']), document.getElementById('levantar').value || '');
      findAndSetText(form, S(['CargaTotal','Carga Total','CargaTotal:']), document.getElementById('cargaTotal').value || '');

      // notas / magias / anotações
      findAndSetText(form, S(['Magias','Magias:','Magias: ']), document.getElementById('magiasList') ? '' : '');
      findAndSetText(form, S(['Anotações','Anotacoes','Anotações:']), '');

      // salvar e retornar bytes
      const pdfBytesOut = await pdfDoc.save();
      return pdfBytesOut;
    }

    document.getElementById("btnExportPdf").addEventListener("click", async () => {
      if (!originalPdf) return alert("Carregue primeiro o PDF editável (botão ao lado).");
      try{
        // cria snapshot dos dados atuais para possibilitar debug
        if(typeof window !== 'undefined' && typeof window.__lastGathered === 'undefined'){
          window.gatherData = function(){ return (function(){ try{ const fn = (function(){ return (window && window.gatherData) ? window.gatherData() : null; }); return fn() || {}; }catch(e){ return {}; } })(); };
        }
        // Garante que funções internas que usamos para obter os dados existam:
        window.gatherData = function(){
          try{
            // tentamos usar a função gatherData definida no script principal; se não existir, criamos um leve fallback
            return (typeof window !== 'undefined' && typeof window.gatherData === 'function' && window.gatherData !== arguments.callee) ? (function(){
              try { return JSON.parse(JSON.stringify((typeof window !== 'undefined' && window.__gather_data_cache) ? window.__gather_data_cache : (function(){ return {}; })())); } catch(e) { return {}; }
            })() : {};
          }catch(e){ return {}; }
        };

        // Para evitar dependência, chamamos a rotina fillPdfFromForm com leitura direta do DOM
        const bytesOut = await fillPdfFromForm(originalPdf);
        const blob = new Blob([bytesOut], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = (document.getElementById('nome').value || 'ficha-preenchida') + '.pdf';
        link.click();
        statusEl.textContent = 'Exportado.';
      }catch(err){
        console.error(err);
        alert('Erro ao preencher/exportar PDF: ' + (err && err.message ? err.message : String(err)));
      }
    });

  })();
  </script>
</body>
</html>
